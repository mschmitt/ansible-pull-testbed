# Post-execution reporting
- hosts: localhost
  gather_facts: true
  connection: local
  tasks:
  - name: Find current git commit id
    shell: git rev-parse HEAD
    register: git_hash
  - name: Configure upload filename
    set_fact:
      upload_file: "commit={{ git_hash.stdout }},state={{ result }},host={{ ansible_hostname }},serial={{ ansible_product_serial }}.txt"
  - name: Upload
    # This is an upload to a public Nextcloud filedrop
    uri:
      url: "{{ upload_url }}/{{ upload_file }}"
      user: "{{ upload_user }}"
      password: ''
      headers:
        X-Requested-With: XMLHttpRequest
      method: PUT
      status_code: 201 # Webdav: 201 Created
      body: "{{ lookup('ansible.builtin.file','/tmp/ansible-pull.txt') }}"
      body_format: raw
# vim: filetype=yaml
